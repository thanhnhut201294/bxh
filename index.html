<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√°i T·∫°o NƒÉng L∆∞·ª£ng - Battle Report</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #e2e8f0;
            --neon-green: #39ff14;
            --neon-red: #ff073a;
            --neon-blue: #00f3ff;
            --neon-gold: #ffd700;
            --neon-purple: #bc13fe;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
        }

        /* √Åp d·ª•ng font Pixel cho ti√™u ƒë·ªÅ v√† s·ªë li·ªáu quan tr·ªçng */
        h1, h2, h3, .pixel-font, .rank-number, .modal-title {
            font-family: 'VT323', monospace;
            text-transform: uppercase;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #334155;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        /* Ticker */
        .ticker-wrap {
            background: #000;
            border-bottom: 2px solid var(--neon-blue);
            white-space: nowrap;
            overflow: hidden;
            padding: 8px 0;
        }
        .ticker {
            display: inline-block;
            animation: marquee 25s linear infinite;
            color: var(--neon-green);
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
        }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* TABLE STYLING */
        .table-custom {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px; /* Kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng */
        }
        .table-custom th {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            color: #94a3b8;
            padding: 10px;
            border-bottom: 1px solid #334155;
        }
        .table-custom td {
            background: #1e293b;
            padding: 15px;
            vertical-align: middle;
            border-top: 1px solid #334155;
            border-bottom: 1px solid #334155;
        }
        .table-custom tr td:first-child { border-left: 1px solid #334155; border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .table-custom tr td:last-child { border-right: 1px solid #334155; border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        /* TIER GOD (Top 3) */
        .row-god td {
            background: rgba(255, 215, 0, 0.1) !important;
            border-color: var(--neon-gold) !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
        }
        .row-god .rank-number { font-size: 2.5rem; color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); }
        .row-god .player-name { font-size: 1.5rem; color: #fff; text-transform: uppercase; letter-spacing: 1px; }

        /* TIER FEEDER (Bottom 3) */
        .row-feeder td {
            background: rgba(255, 7, 58, 0.1) !important;
            border-color: var(--neon-red) !important;
        }
        .row-feeder .rank-number { font-size: 2rem; color: var(--neon-red); }
        .row-feeder .player-name { color: #fca5a5; }

        /* Rank Colors */
        .rank-1 { color: var(--neon-gold); }
        .rank-2 { color: #C0C0C0; } /* Silver */
        .rank-3 { color: #CD7F32; } /* Bronze */

        /* Badges */
        .badge-pixel {
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 5px;
        }
        .bg-day { background: #f59e0b; color: #000; }
        .bg-night { background: #3b82f6; color: #fff; }

        /* Modal Elements */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
            gap: 4px;
            margin-top: 10px;
        }
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            background: #334155;
            position: relative;
        }
        .heatmap-cell:hover::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; padding: 2px 5px;
            font-size: 10px; white-space: nowrap; z-index: 10;
            pointer-events: none;
        }

        /* Loading */
        #loading {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: var(--bg-dark); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="loading">
        <h1 class="pixel-font" style="font-size: 3rem; color: var(--neon-green);">LOADING DATA...</h1>
        <div class="spinner-border text-info" role="status"></div>
    </div>

    <div class="ticker-wrap">
        <div class="ticker" id="liveTicker">ƒêang k·∫øt n·ªëi t·ªõi m√°y ch·ªß Google Sheet...</div>
    </div>

    <div class="container py-5">
        <div class="text-center mb-5">
            <h1 class="pixel-font display-3 mb-2" style="text-shadow: 2px 2px 0 var(--neon-blue);">
                <i class="fas fa-skull-crossbones"></i> BATTLE REPORT
            </h1>
            <p class="text-muted pixel-font fs-4">Th·ªëng k√™ S√°t Ph·∫°t H·ªôi - Realtime</p>
        </div>

        <div class="glass-card p-3 p-md-4">
            <div class="table-responsive">
                <table class="table-custom text-nowrap">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th>Ng∆∞·ªùi ch∆°i (Player)</th>
                            <th class="text-center">S·ªë tr·∫≠n</th>
                            <th class="text-center">Win Rate</th>
                            <th class="text-center">Phong ƒë·ªô (5 tr·∫≠n)</th>
                            <th class="text-end">T·ªïng ƒêi·ªÉm (EXP)</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center mt-4 text-muted pixel-font">
            D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông t·ª´ Google Sheet
        </div>
    </div>

    <div class="modal fade" id="playerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content glass-card" style="background: #1e293b; color: white;">
                <div class="modal-header border-bottom border-secondary">
                    <h2 class="modal-title fs-2" id="modalName" style="color: var(--neon-green);">PLAYER</h2>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-md-5 text-center border-end border-secondary">
                            <div class="mb-3">
                                <h1 class="display-1 pixel-font" id="modalRank" style="color: var(--neon-gold);">#1</h1>
                                <div id="modalBadges"></div>
                            </div>
                            
                            <div style="position: relative; height: 250px; width: 100%;">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>

                        <div class="col-md-7">
                            <div class="row mb-3 pixel-font fs-5">
                                <div class="col-6">
                                    <div class="p-2 border border-secondary rounded text-center">
                                        <div class="text-muted fs-6">Cao nh·∫•t (Max)</div>
                                        <div class="text-success" id="modalMax">+0</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 border border-secondary rounded text-center">
                                        <div class="text-muted fs-6">Th·∫•p nh·∫•t (Min)</div>
                                        <div class="text-danger" id="modalMin">-0</div>
                                    </div>
                                </div>
                            </div>

                            <ul class="list-group list-group-flush bg-transparent mb-4">
                                <li class="list-group-item bg-transparent text-white d-flex justify-content-between">
                                    <span>üíÄ Kh·∫Øc tinh (Thua nhi·ªÅu nh·∫•t):</span>
                                    <strong id="modalNemesis" class="text-danger">---</strong>
                                </li>
                                <li class="list-group-item bg-transparent text-white d-flex justify-content-between">
                                    <span>üçñ Con m·ªìi (Th·∫Øng nhi·ªÅu nh·∫•t):</span>
                                    <strong id="modalPrey" class="text-success">---</strong>
                                </li>
                            </ul>

                            <h5 class="pixel-font border-bottom border-secondary pb-1">L·ªãch s·ª≠ (Heatmap)</h5>
                            <div id="modalHeatmap" class="heatmap-grid"></div>
                            <div class="d-flex justify-content-between mt-1" style="font-size: 0.7rem; color: #94a3b8;">
                                <span>Thua (ƒê·ªè)</span>
                                <span>Th·∫Øng (Xanh)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // LINK CSV C·ª¶A B·∫†N
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRvJLnrZU9iHP1XzU8JMQD3C2xPzkKrHMIzWsvpyVDmayFK_dd5-xwnNtBshPtLYauwd8GnaK5gS4FH/pub?gid=1796395162&single=true&output=csv";

        let players = {};
        let matches = {};
        let radarChartInstance = null;

        document.addEventListener("DOMContentLoaded", () => {
            fetchData();
        });

        function fetchData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    processData(results.data);
                    renderUI();
                    document.getElementById('loading').style.display = 'none';
                },
                error: (err) => alert("L·ªói t·∫£i data: " + err)
            });
        }

        function processData(data) {
            players = {};
            matches = {};

            data.forEach(row => {
                if (!row.Name || !row.Core || !row.Date) return;

                // Chu·∫©n h√≥a t√™n & d·ªØ li·ªáu
                const name = row.Name.trim().charAt(0).toUpperCase() + row.Name.trim().slice(1).toLowerCase();
                const score = parseInt(row.Core);
                const dateRaw = row.Date.split(' ')[0]; // dd/mm/yyyy
                const timeRaw = row.Date.split(' ')[1] || "00:00:00";
                
                // Match ID = Date + Time + Sheet
                const matchId = `${row.Date}_${row.Sheet}`;

                if (!players[name]) {
                    players[name] = {
                        name: name,
                        totalScore: 0,
                        matchCount: 0,
                        wins: 0,
                        losses: 0,
                        scores: [],
                        dates: {},
                        nemesisMap: {}, // B·ªã ai ƒë√°nh b·∫°i
                        preyMap: {}, // ƒê√°nh b·∫°i ai
                        playTime: { day: 0, night: 0 } // ƒê·∫øm s·ªë tr·∫≠n s√°ng/t·ªëi
                    };
                }

                if (!matches[matchId]) {
                    matches[matchId] = { players: [], scores: {} };
                }

                // C·∫≠p nh·∫≠t ch·ªâ s·ªë c∆° b·∫£n
                players[name].totalScore += score;
                players[name].matchCount++;
                players[name].scores.push(score);
                if (score > 0) players[name].wins++; else players[name].losses++;

                // Heatmap
                if (!players[name].dates[dateRaw]) players[name].dates[dateRaw] = 0;
                players[name].dates[dateRaw] += score;

                // Match Tracking
                matches[matchId].players.push(name);
                matches[matchId].scores[name] = score;

                // Day/Night Logic (Gi·∫£ s·ª≠ 6h - 18h l√† Day)
                const hour = parseInt(timeRaw.split(':')[0]);
                if (hour >= 6 && hour < 18) players[name].playTime.day++;
                else players[name].playTime.night++;
            });

            // X·ª≠ l√Ω Nemesis/Prey & Class
            calculateAdvancedStats();
        }

        function calculateAdvancedStats() {
            // Nemesis logic
            Object.values(matches).forEach(m => {
                const winners = m.players.filter(p => m.scores[p] > 0);
                const losers = m.players.filter(p => m.scores[p] < 0);
                
                losers.forEach(l => {
                    winners.forEach(w => {
                        if (!players[l].nemesisMap[w]) players[l].nemesisMap[w] = 0;
                        players[l].nemesisMap[w]++; // l thua w

                        if (!players[w].preyMap[l]) players[w].preyMap[l] = 0;
                        players[w].preyMap[l]++; // w th·∫Øng l
                    });
                });
            });

            // T√≠nh to√°n cu·ªëi c√πng cho t·ª´ng player
            Object.values(players).forEach(p => {
                // Find Max Nemesis
                p.nemesis = getMaxKey(p.nemesisMap);
                p.prey = getMaxKey(p.preyMap);
                
                // Stats for Radar
                const avgScore = p.totalScore / p.matchCount;
                const winRate = (p.wins / p.matchCount) * 100;
                const maxScore = Math.max(...p.scores);
                
                // T√≠nh ƒë·ªô ·ªïn ƒë·ªãnh (Standard Deviation ngh·ªãch ƒë·∫£o - c√†ng th·∫•p c√†ng t·ªët)
                const mean = p.scores.reduce((a,b)=>a+b,0)/p.scores.length;
                const variance = p.scores.reduce((a,b)=>a+Math.pow(b-mean,2),0)/p.scores.length;
                const stdDev = Math.sqrt(variance);
                
                p.stats = {
                    damage: Math.min(100, (maxScore / 50) * 100), // Max ƒëi·ªÉm
                    tank: Math.min(100, (p.matchCount / 20) * 100), // S·ªë tr·∫≠n (gi·∫£ s·ª≠ 20 l√† nhi·ªÅu)
                    luck: winRate,
                    stability: Math.max(0, 100 - stdDev), // ·ªîn ƒë·ªãnh
                    form: calculateRecentForm(p.scores) // ƒêi·ªÉm phong ƒë·ªô 5 tr·∫≠n cu·ªëi
                };
            });
        }

        function getMaxKey(obj) {
            let maxKey = "---";
            let maxVal = 0;
            for(const [k, v] of Object.entries(obj)) {
                if(v > maxVal) { maxVal = v; maxKey = k; }
            }
            return maxKey;
        }

        function calculateRecentForm(scores) {
            const last5 = scores.slice(-5);
            const positive = last5.filter(s => s > 0).length;
            return (positive / last5.length) * 100;
        }

        function renderUI() {
            renderLeaderboard();
            renderTicker();
        }

        function renderTicker() {
            const sorted = Object.values(players).sort((a,b) => b.totalScore - a.totalScore);
            const top = sorted[0];
            const bottom = sorted[sorted.length-1];
            
            const msgs = [
                `üëë TOP 1 SERVER: ${top.name} (${top.totalScore} EXP)`,
                `üíÄ B√ÅO TH·ª¶: ${bottom.name} (${bottom.totalScore} EXP)`,
                `üìÖ D·ªØ li·ªáu c·∫≠p nh·∫≠t m·ªõi nh·∫•t t·ª´ Google Sheet`,
                `üî• Chi·∫øn tr∆∞·ªùng r·ª±c l·ª≠a!`
            ];
            document.getElementById('liveTicker').innerText = msgs.join("  +++  ");
        }

        function renderLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            const sortedPlayers = Object.values(players).sort((a, b) => b.totalScore - a.totalScore);
            const totalPlayers = sortedPlayers.length;

            sortedPlayers.forEach((p, index) => {
                const rank = index + 1;
                let rowClass = '';
                let rankIcon = `#${rank}`;

                // Logic ph√¢n lo·∫°i Tier S v√† F
                if (index < 3) {
                    rowClass = 'row-god'; // Top 3
                    if(rank === 1) rankIcon = 'üëë'; 
                    if(rank === 2) rankIcon = 'ü•à'; 
                    if(rank === 3) rankIcon = 'ü•â'; 
                } else if (index >= totalPlayers - 3) {
                    rowClass = 'row-feeder'; // Bottom 3
                    rankIcon = 'üíÄ';
                }

                // Winrate Color
                const wr = ((p.wins / p.matchCount) * 100).toFixed(0);
                const wrColor = wr >= 50 ? 'text-success' : 'text-danger';

                // Sparkline Trend (5 tr·∫≠n g·∫ßn nh·∫•t)
                const last5 = p.scores.slice(-5);
                const trendHtml = last5.map(s => {
                    const color = s >= 0 ? 'var(--neon-green)' : 'var(--neon-red)';
                    const height = Math.min(100, Math.abs(s)*2) + 10; // Simple height scaling
                    return `<div style="width:4px; height:${height}%; background:${color}; display:inline-block; margin-right:2px; border-radius:1px;"></div>`;
                }).join('');

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.onclick = () => showPlayerModal(p.name);
                tr.style.cursor = 'pointer';
                
                tr.innerHTML = `
                    <td class="text-center"><span class="rank-number ${'rank-'+rank}">${rankIcon}</span></td>
                    <td>
                        <div class="player-name fw-bold">${p.name}</div>
                        <div class="small text-muted" style="font-family:'VT323'; font-size:1.1rem;">
                            ${p.playTime.night > p.playTime.day ? '<i class="fas fa-moon text-info"></i> NightOwl' : '<i class="fas fa-sun text-warning"></i> DayWalker'}
                        </div>
                    </td>
                    <td class="text-center pixel-font fs-4 text-white">${p.matchCount}</td>
                    <td class="text-center pixel-font fs-4 ${wrColor}">${wr}%</td>
                    <td class="text-center" style="height: 50px; vertical-align:middle;">
                        <div style="height:30px; display:flex; align-items:flex-end; justify-content:center;">${trendHtml}</div>
                    </td>
                    <td class="text-end pixel-font fs-3 fw-bold ${p.totalScore > 0 ? 'text-success' : 'text-danger'}">
                        ${p.totalScore > 0 ? '+' : ''}${p.totalScore}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showPlayerModal(name) {
            const p = players[name];
            
            document.getElementById('modalName').innerText = p.name;
            const rank = Object.values(players).sort((a,b)=>b.totalScore-a.totalScore).findIndex(x=>x.name===name) + 1;
            document.getElementById('modalRank').innerText = `#${rank}`;
            
            // Badges
            const badgeContainer = document.getElementById('modalBadges');
            let badgeHtml = '';
            if (p.playTime.night > p.playTime.day) badgeHtml += '<span class="badge badge-pixel bg-night">ü¶â Night Owl</span>';
            else badgeHtml += '<span class="badge badge-pixel bg-day">‚òÄÔ∏è Day Walker</span>';
            badgeContainer.innerHTML = badgeHtml;

            // Stats
            document.getElementById('modalNemesis').innerText = p.nemesis;
            document.getElementById('modalPrey').innerText = p.prey;
            document.getElementById('modalMax').innerText = (Math.max(...p.scores) > 0 ? '+' : '') + Math.max(...p.scores);
            document.getElementById('modalMin').innerText = Math.min(...p.scores);

            // Heatmap
            const hm = document.getElementById('modalHeatmap');
            hm.innerHTML = '';
            const dates = Object.keys(p.dates).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            dates.forEach(d => {
                const s = p.dates[d];
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.setAttribute('data-title', `${d}: ${s}`);
                if (s > 0) cell.style.background = 'var(--neon-green)';
                else if (s < 0) cell.style.background = 'var(--neon-red)';
                else cell.style.background = '#64748b';
                
                // Opacity based on magnitude
                const opacity = Math.min(1, Math.abs(s) / 30 + 0.3);
                cell.style.opacity = opacity;
                
                hm.appendChild(cell);
            });

            // Radar Chart
            renderRadarChart(p);

            const modal = new bootstrap.Modal(document.getElementById('playerModal'));
            modal.show();
        }

        function renderRadarChart(p) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(radarChartInstance) radarChartInstance.destroy();

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['S√°t Th∆∞∆°ng', 'ƒê·ªô L√¨', 'May M·∫Øn', '·ªîn ƒê·ªãnh', 'Phong ƒê·ªô'],
                    datasets: [{
                        label: p.name,
                        data: [p.stats.damage, p.stats.tank, p.stats.luck, p.stats.stability, p.stats.form],
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: '#39ff14',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#39ff14'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#334155' },
                            grid: { color: '#334155' },
                            pointLabels: { color: '#fff', font: { family: 'VT323', size: 16 } },
                            ticks: { display: false, max: 100, min: 0 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
